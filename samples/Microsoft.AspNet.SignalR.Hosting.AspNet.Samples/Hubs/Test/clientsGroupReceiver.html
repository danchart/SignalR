<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>    
    <script src="../../Scripts/signalr.samples.js"></script>
    <script src="../../Scripts/jquery-1.8.2.js"></script>
    <script src="../../Scripts/jquery.signalr.js"></script>
    <script src="../../Scripts/hubs.js"></script>
    <script src="test.js"></script>
    <script type="text/javascript">
        var messages = new Array();
        var groupName = "group1";

        var hubConnection = $.connection.hub;
        hubConnection.logging = true;

        hubConnection.connectionSlow(function () {
            $("#HubMessages").append("<li style='color:blue;'>connectionSlow:</li>");
        });
        hubConnection.disconnected(function () {
            $("#HubMessages").append("<li>disconnected:</li>");
        });
        hubConnection.error(function (error) {
            $("#HubMessages").append("<li style='color:red;'>error: " + error + "</li>");
        });
        //this method receives data from all hubs in json format, we dont want to see this
        //hubConnection.received(function (data) {
        //    $("#HubMessages").append("<li>received: " + data + "</li>");
        //});
        hubConnection.reconnected(function () {
            $("#HubMessages").append("<li>reconnected:</li>");
        });
        hubConnection.reconnecting(function () {
            $("#HubMessages").append("<li style='color:blue;'>reconnecting:</li>");
        });
        hubConnection.starting(function () {
            $("#HubMessages").append("<li style='color:blue;'>starting:</li>");
        });
        hubConnection.stateChanged(function (change) {
            $("#HubMessages").append("<li>stateChanged: " + PrintState(change.oldState) + " => " + PrintState(change.newState) + "</li>");
        });

        var testHub = $.connection.stressHub;
        testHub.client.clientConnected = function (nodeEvent) {
            $("#HubMessages").append("<li>clientConnected: " + JSON.stringify(nodeEvent) + "</li>");
            $("#ConnectionsList").append("<option id=" + nodeEvent.Data + ">" + nodeEvent.Data + "</option>");
        };
        testHub.client.clientDisconnected = function (nodeEvent) {
            $("#HubMessages").append("<li>clientDisconnected: " + JSON.stringify(nodeEvent) + "</li>");
            $("#ConnectionsList option[id=" + nodeEvent.Data + "]").remove();
        };
        testHub.client.clientReconnected = function (nodeEvent) {
            $("#HubMessages").append("<li>clientReconnected: " + JSON.stringify(nodeEvent) + "</li>");
            $("#ConnectionsList").append("<option id=" + nodeEvent.Data + ">" + nodeEvent.Data + "</option>");
        };
        testHub.client.joinedGroupsAdd = function (nodeEvent) {
            $("#HubMessages").append("<li>joinedGroupsAdd: " + JSON.stringify(nodeEvent) + "</li>");
        };
        testHub.client.clientsGroup = function (nodeEvent) {
            incrementLabel("#ReceivedLabel");
            var message = parseInt(nodeEvent.Data);
            if (messages[message] == undefined) {
                messages[message] = 1;
            } else {
                messages[message] = messages[message] + 1;
                $("#HubMessages").append("<li style='color:red;'>Message " + message + " has been received " + messages[message] + " times</li>");
            }
        };

        hubConnection.start({ transport: activeTransport })
            .done(function () {
                $("#HubMessages").append("<li>Connection started!</li>");
                $("#HubMessages").append("<li>hubConnection.ajaxDataType: " + hubConnection.ajaxDataType + "</li>");
                $("#HubMessages").append("<li>hubConnection.disconnectTimeout: " + hubConnection.disconnectTimeout + "</li>");
                $("#HubMessages").append("<li>hubConnection.id: " + hubConnection.id + "</li>");
                $("#HubMessages").append("<li>hubConnection.logging: " + hubConnection.logging + "</li>");
                $("#HubMessages").append("<li>hubConnection.keepAliveData.activated: " + hubConnection.keepAliveData.activated + "</li>");
                $("#HubMessages").append("<li>hubConnection.keepAliveData.checkInterval: " + hubConnection.keepAliveData.checkInterval + "</li>");
                $("#HubMessages").append("<li>hubConnection.keepAliveData.lastKeepAlive: " + hubConnection.keepAliveData.lastKeepAlive + "</li>");
                $("#HubMessages").append("<li>hubConnection.keepAliveData.timeout: " + hubConnection.keepAliveData.timeout + "</li>");
                $("#HubMessages").append("<li>hubConnection.keepAliveData.timeoutWarning: " + hubConnection.keepAliveData.timeoutWarning + "</li>");
                $("#HubMessages").append("<li>hubConnection.keepAliveWarnAt: " + hubConnection.keepAliveWarnAt + "</li>");
                $("#HubMessages").append("<li>hubConnection.qs: " + hubConnection.qs + "</li>");
                $("#HubMessages").append("<li>hubConnection.reconnectDelay: " + hubConnection.reconnectDelay + "</li>");
                $("#HubMessages").append("<li>hubConnection.state: " + PrintState(hubConnection.state) + "</li>");
                $("#HubMessages").append("<li>hubConnection.token: " + hubConnection.token + "</li>");
                $("#HubMessages").append("<li>hubConnection.transport.name: " + hubConnection.transport.name + "</li>");
                $("#HubMessages").append("<li>hubConnection.url: " + hubConnection.url + "</li>");

                $("#HubMessages").append("<li>testHub.hubName: " + testHub.hubName + "</li>");
                
                testHub.server.groupsAdd(hubConnection.id, groupName);
            })
            .fail(function (error) {
                $("#HubMessages").append("<li style='color:red;'>Connection failed:" + error + "</li>");
            });        
    </script>
</head>
<body>
    <table>
        <tr>
            <td>Try other transports:</td>
            <td><a href="clientsGroupReceiver.html?transport=webSockets">webSockets</a></td>
            <td><a href="clientsGroupReceiver.html?transport=foreverFrame">foreverFrame</a></td>
            <td><a href="clientsGroupReceiver.html?transport=serverSentEvents">serverSentEvents</a></td>
            <td><a href="clientsGroupReceiver.html?transport=longPolling">longPolling</a></td>
        </tr>
    </table>   
    <table>
        <tr>
            <td>Send: <label id="SendLabel">0</label></td>
            <td>Received: <label id="ReceivedLabel">0</label></td>
        </tr> 
    </table>

    <h1>TestHub</h1>    
    <ul id="HubMessages">
    </ul>
</body>
</html>
